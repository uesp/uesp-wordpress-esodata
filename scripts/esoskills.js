
	/* Set to false to use the default Eso-Hub set tooltips */
window.EsoOverrideEsoHubSets = true;
window.EsoOverrideEsoHubCPs = true;

window.EsoShouldShowSkillToolip = false;
window.EsoShouldShowSetToolip = false;
window.EsoShouldShowCPToolip = false;

window.ESO_SETNAME_FIXUP = 
	{
	 	"New Moon" : "New Moon Acolyte",
	 	"Oakensoul" : "Oakensoul Ring",
	 	"Oakensoul ring" : "Oakensoul Ring",
	 	"Pale Order" : "Ring of the Pale Order",
	 	"Beserking Warrior" : "Berserking Warrior",
	 	"Blessing of Potentates" : "Blessing of the Potentates",
	 	"Potentates" : "Blessing of the Potentates",
	 	"Buffer of Swift" : "Buffer of the Swift",
	 	"Burning Spell Weave" : "Burning Spellweave",
	 	"Deadly Strikes" : "Deadly Strike",
	 	"Dro'Zakar's" : "Dro'Zakar's Claws",
	 	"Dro'Zakar's Claw" : "Dro'Zakar's Claws",
	 	"Gaze" : "Gaze of Sithis",
	 	"Gryphons Reprisal" : "Gryphon's Reprisal",
	 	"Ice Heart" : "Iceheart",
	 	"Kinra's" : "Kinras's Wrath",
	 	"Kinra's Wrath" : "Kinras's Wrath",
	 	"1 piece Kra'gh" : "Kra'gh",
	 	"1pc or 2 pc Kra'gh" : "Kra'gh",
	 	"1PC Magma Incarnate" : " Magma Incarnate",
	 	"Malacath" : "Malacath's Band of Brutality",
	 	"Pariah" : "Mark of the Pariah",
	 	"Medusa from Arx" : "Medusa",
	 	"Mora's Whisper" : "Mora's Whispers",
	 	"Perfect Arms of Relequen" : "Perfected Arms of Relequen",
	 	"Relequen" : "Perfected Arms of Relequen",
	 	"Claw of Yolnhakriin" : "Claw of Yolnahkriin",
	 	"Perfected Claw of Yolnhakriin" : "Perfected Claw of Yolnahkriin",
	 	"Perfected False Gods" : "Perfected False God's Devotion",
	 	"Perfected False Gods" : "Perfected False God's Devotion",
	 	"Sul Xan" : "Sul-Xan's Torment",
	 	"Maelstrom Weapon" : "Perfected Thunderous Volley",
	 	"Perfected Timelss Blessing" : "Perfected Timeless Blessing",
	 	"Perfect Vestment of Olorime" : "Perfected Vestment of Olorime",
	 	"Perfected Vestments of Olorime" : "Perfected Vestment of Olorime",
	 	"Blackrose Prison Weapon" : "Perfected Virulent Shot",
	 	"Pillars of Nirn" : "Pillar of Nirn",
	 	"Wild Hunt" : "Ring of the Wild Hunt",
	 	"Withered Hand" : "Robes of the Withered Hand",
	 	"Death Dealer's Fate" : "Death Dealer's Fete",
	 	"2pc Scourge Harvest" : "Scourge Harvester",
	 	"Scourge Harvest" : "Scourge Harvester",
	 	"Sea Serpent Coil" : "Sea-Serpent's Coil",
	 	"2pc Selene" : "Selene",
	 	"Spriggan's Thorn" : "Spriggan's Thorns",
	 	"Spriggan's Throns" : "Spriggan's Thorns",
	 	"Spriggans" : "Spriggan's Thorns",
	 	"2pc Stormfist" : "Stormfist",
	 	"Troll King" : "The Troll King",
	 	"Torc" : "Torc of Tonal Constancy",
	 	"Torc or Tonal Constancy" : "Torc of Tonal Constancy",
	 	"1 piece Skoria" : "Skoria",
	 	"the Ever-Wakeful" : "Zoal the Ever-Wakeful",
	 	"Zoal" : "Zoal the Ever-Wakeful",
	};

	// Wiki specific name fixups
window.ESO_SETNAME_ARTICLE_FIXUP = 
{
		"Agility" : "Agility (set)",
		"Alessian Order" : "Alessian Order (set)",
		"Balorgh" : "Balorgh (set)",
		"Baron Thirsk" : "Baron Thirsk (set)",
		"Baron Zaudrus" : "Baron Zaudrus (set)",
		"Bloodspawn" : "Bloodspawn (set)",
		"Chokethorn" : "Chokethorn (set)",
		"Giant Spider" : "Giant Spider (set)",
		"Glorgoloch the Destroyer" : "Glorgoloch the Destroyer (set)",
		"Grave Guardian" : "Grave Guardian (set)",
		"Grothdarr" : "Grothdarr (set)",
		"Grundwulf" : "Grundwulf (set)",
		"Iceheart" : "Iceheart (set)",
		"Immolator Charr" : "Immolator Charr (set)",
		"Infernal Guardian" : "Infernal Guardian (set)",
		"Kargaeda" : "Kargaeda (set)",
		"Lady Malygda" : "Lady Malygda (set)",
		"Lady Thorn" : "Lady Thorn (set)",
		"Maarselok" : "Maarselok (set)",
		"Magma Incarnate" : "Magma Incarnate (set)",
		"Maw of the Infernal" : "Maw of the Infernal (set)",
		"Might Chudan" : "Might Chudan (set)",
		"Molag Kena" : "Molag Kena (set)",
		"Mother Ciannait" : "Mother Ciannait (set)",
		"Nazaray" : "Nazaray (set)",
		"Nerien'eth" : "Nerien'eth (set)",
		"Night Terror" : "Night Terror (set)",
		"Nunatak" : "Nunatak (set)",
		"Selene" : "Selene (set)",
		"Sentinel of Rkugamz" : "Sentinel of Rkugamz (set)",
		"Sentry" : "Sentry (set)",
		"Shadow Walker" : "Shadow Walker (set)",
		"Shadowrend" : "Shadowrend (set)",
		"Slimecraw" : "Slimecraw (set)",
		"Spawn of Mephala" : "Spawn of Mephala (set)",
		"Stone Husk" : "Stone Husk (set)",
		"Stormfist" : "Stormfist (set)",
		"Swarm Mother" : "Swarm Mother (set)",
		"Symphony of Blades" : "Symphony of Blades (set)",
		"Thurvokun" : "Thurvokun (set)",
		"Tremorscale" : "Tremorscale (set)",
		"The Troll King" : "The Troll King (set)",
		"Valkyn Skoria" : "Valkyn Skoria (set)",
		"Vampire Lord" : "Vampire Lord (set)",
		"Velidreth" : "Velidreth (set)",
		"Winterborn" : "Winterborn (set)",
		"Zoal the Ever-Wakeful" : "Zoal the Ever-Wakeful (set)",
	};


window.EsoShowPopupCPTooltip = function(cpHtml, parent)
{
	var popupElement = jQuery("#esovsPopupCPTooltip");
	
	if (popupElement.length == 0)
	{
		jQuery("body").append('<div id="esovsPopupCPTooltip"></div>');
		popupElement = jQuery("#esovsPopupCPTooltip");
	}
	
	if (cpHtml == null)
	{
		popupElement.hide();
		return;
	}
	
	popupElement.html(cpHtml);
	popupElement.show();
	
	AdjustEsoPopupTooltipPosition(popupElement, jQuery(parent));
}


window.EsoShowPopupSkillTooltip = function(skillHtml, parent)
{
	var popupElement = jQuery("#esovsPopupSkillTooltip");
	
	if (popupElement.length == 0)
	{
		jQuery("body").append('<div id="esovsPopupSkillTooltip"></div>');
		popupElement = jQuery("#esovsPopupSkillTooltip");
	}
	
	if (skillHtml == null)
	{
		popupElement.hide();
		return;
	}
	
	popupElement.html(skillHtml);
	popupElement.show();
	
	AdjustEsoPopupTooltipPosition(popupElement, jQuery(parent));
}


window.AdjustEsoPopupTooltipPositionMobile = function (tooltip, parent)
{
	if (tooltip == null) return;
	if (tooltip[0] == null) return;
	if (parent == null) return;
	
	var windowWidth = jQuery(window).width();
	var windowHeight = jQuery(window).height();
	var toolTipWidth = tooltip.width();
	var toolTipHeight = tooltip.height();
	var elementHeight = parent.height();
	var elementWidth = parent.width();
	
	var top = parent.offset().top + elementHeight + 10;
	var left = windowWidth/2 - toolTipWidth/2;
	
	tooltip.offset({ top: top, left: left });
}


window.AdjustEsoPopupTooltipPosition = function (tooltip, parent)
{
	if (tooltip == null) return;
	if (tooltip[0] == null) return;
	if (parent == null) return;
	
	var isMobile = parseInt(parent.attr("isMobile"));
	if (isMobile) return window.AdjustEsoPopupTooltipPositionMobile(tooltip, parent)
	
	var windowWidth = jQuery(window).width();
	var windowHeight = jQuery(window).height();
	var toolTipWidth = tooltip.width();
	var toolTipHeight = tooltip.height();
	var elementHeight = parent.height();
	var elementWidth = parent.width();
	
	var top = parent.offset().top - toolTipHeight/2 + elementHeight/2;
	var left = parent.offset().left + parent.outerWidth() + 3;
	
	tooltip.offset({ top: top, left: left });
	
	var viewportTooltip = tooltip[0].getBoundingClientRect();
	
	if (viewportTooltip.bottom > windowHeight) 
	{
		var deltaHeight = viewportTooltip.bottom - windowHeight + 10;
		top = top - deltaHeight
	}
	else if (viewportTooltip.top < 120)
	{
		var deltaHeight = viewportTooltip.top - 120;
		top = top - deltaHeight
	}
	
	if (viewportTooltip.right > windowWidth) 
	{
		left = left - toolTipWidth - parent.width() - 28;
	}
	
	tooltip.offset({ top: top, left: left });
	viewportTooltip = tooltip[0].getBoundingClientRect();
	
	if (viewportTooltip.left < 0)
	{
		var el = jQuery('<i/>').css('display','inline').insertBefore(parent[0]);
		var realOffset = el.offset();
		el.remove();
		
		left = realOffset.left - toolTipWidth - 3;
		tooltip.offset({ top: top, left: left });
	}
}


function OnEsoDataSkillClientHover(e)
{
	EsoShouldShowSkillToolip = true;
	
	var element = jQuery(this).find(".uespEsoSkillIcon");
	var skillid = element.attr("skillid");
	var skillName = element.attr("skillname");
	var isMobile = element.attr("isMobile");
	var version = element.attr("version"); 
	
	if ((skillid == null || skillid == "") && (skillName == null || skillName == "")) 
	{
		return;
	}
	
	if (version == null || version == "current") version = "";
	
	jQuery.ajax({
		url: '//esolog.uesp.net/skillTooltip.php',
		data:  { 'id' : skillid, 'name' : skillName, 'includelink' : isMobile, 'version' : version },
		type: 'get',
		context: element,
		dataType: 'html',
		cache: false,
		success: OnReceiveEsoDataSkillClientData,
		async:true,
	});
	
	//EsoShowPopupSkillTooltip(skillData, jQuery(this)[0]);
}


function OnEsoDataCPClientHover(e)
{
	EsoShouldShowCPToolip = true;
	
	var element = jQuery(this);
	var cpName = element.text();
	var isMobile = element.attr("isMobile");
	var version = element.attr("version"); 
	
	if (cpName == null || cpName == "")
	{
		return;
	}
	
	if (version == null || version == "current") version = "";
	
	jQuery.ajax({
		url: '//esolog.uesp.net/cpTooltip.php',
		data:  { 'name' : cpName, 'includelink' : isMobile, 'version' : version },
		type: 'get',
		context: element,
		dataType: 'html',
		cache: false,
		success: OnReceiveEsoDataCPClientData,
		async:true,
	});
}


function OnReceiveEsoDataSkillClientData(skillData)
{
	if (!EsoShouldShowSkillToolip) return;
	EsoShowPopupSkillTooltip(skillData, jQuery(this));
}


function OnReceiveEsoDataCPClientData(cpData)
{
	if (!EsoShouldShowCPToolip) return;
	EsoShowPopupCPTooltip(cpData, jQuery(this));
}


function OnEsoDataSkillClientLeave(e)
{
	var popupElement = jQuery("#esovsPopupSkillTooltip");
	popupElement.hide();
	EsoShouldShowSkillToolip = false;
}


function OnEsoDataCPClientLeave(e)
{
	var popupElement = jQuery("#esovsPopupCPTooltip");
	popupElement.hide();
	EsoShouldShowCPToolip = false;
}


window.EsoShowPopupSetTooltip = function(setImageUrl, parent)
{
	var popupElement = jQuery("#esovsPopupSetTooltip");
	
	if (popupElement.length == 0)
	{
		jQuery("body").append('<div id="esovsPopupSetTooltip"></div>');
		popupElement = jQuery("#esovsPopupSetTooltip");
	}
	
	if (setImageUrl == null || setImageUrl == "")
	{
		popupElement.hide();
		return;
	}
	
	var image = jQuery("<img/>").attr("src", setImageUrl).on("load", function() {
		OnEsoSetImageLoad(jQuery(parent));
	});
	
	popupElement.html(image);
}


window.OnEsoSetImageLoad = function(parent)
{
	var popupElement = jQuery("#esovsPopupSetTooltip");
	
	if (!EsoShouldShowSetToolip) return;
	
	popupElement.show();
	AdjustEsoPopupTooltipPosition(popupElement, parent);
}


function OnEsoDataSetClientHover(e)
{
	EsoShouldShowSetToolip = true;
	
	var element = jQuery(this);
	var setName = element.attr("setname");
	var isMobile = element.attr("isMobile");
	var version = element.attr("version"); 
	
	if (setName == null || setName == "") 
	{
		return;
	}
	
	if (version == null || version == "current") version = "";
	
	//safeName = encodeURIComponent(setName);
	var safeName = setName.replace(/"/g, "&quot;");
	
	EsoShowPopupSetTooltip("https://esolog.uesp.net/itemLinkImage.php?set=" + safeName + "&version=" + version + "", this);
}


function OnEsoDataSetClientLeave(e)
{
	var popupElement = jQuery("#esovsPopupSetTooltip");
	popupElement.hide();
	EsoShouldShowSetToolip = false;
}


function EsoDataFixSetName(setName)
{
	setName = setName.trim();
	setName = setName.replace("’", "'");
	setName = setName.replace(/^Perfect /i, "Perfected ");
	setName = setName.replace(/:$/, "");
	setName = setName.replace(/ Set$/i, "");
	
	var fixupName = ESO_SETNAME_FIXUP[setName];
	if (fixupName) setName = fixupName;
	
	return setName;
}


function EsoDataFixSetNameArticle(setName)
{
	setName = EsoDataFixSetName(setName);
	
	var fixupName = ESO_SETNAME_ARTICLE_FIXUP[setName];
	if (fixupName) setName = fixupName;
	
	return setName;
}


function EsoDataUpdateEsoHubSetLink(link)
{
	var $link = jQuery(link);
	var setName = $link.text();
	var oldLink = $link.attr("href");
	
	setName = EsoDataFixSetName(setName);
	var articleName = EsoDataFixSetNameArticle(setName);
	
		// TODO: Replace with proper check?
	var isMobile = ("ontouchstart" in document.documentElement);
	
	var safeName = setName.replace(/"/g, "&quot;");
	var safeArticle = articleName.replace(/"/g, "&quot;");
	var newLink = "https://en.uesp.net/wiki/Online:" + safeArticle;
	
		// <a href=\"$link\" version=\"$version\" ismobile=\"$isMobile\" class=\"uespEsoSetLink\" setname=\"$safeName\">$title</a>
	$link.addClass("uespEsoSetLink");
	$link.attr("version", "");
	$link.attr("ismobile", isMobile ? "1" : "0");
	$link.attr("setname", safeName);
	$link.attr("href", newLink);
	$link.attr("oldlink", oldLink);
	$link.attr("target", "_blank");
	
	var $newLink = $link.clone(false);
	
	$link.replaceWith($newLink);
}


function EsoDataUpdateAllEsoHubSetLinks()
{
	if (!EsoOverrideEsoHubSets) return;
	
	var links = jQuery("a");
	
	links.each(function() {
		
			//<a href="https://eso-hub.com/en/sets/lady-malygda">Lady Malygda</a>
		if (this.href.startsWith('https://eso-hub.com/en/sets/') || this.href.startsWith('https://www.eso-hub.com/en/sets/'))
		{
			EsoDataUpdateEsoHubSetLink(this);
		}
	});
}



function EsoDataUpdateUespSetLink(link)
{
	var $link = jQuery(link);
	var matches = link.href.match(/https:\/\/en.uesp.net\/wiki\/Online:(.*)\?set/)
	
	if (!matches) return;
	
	var setName = matches[1];
	if (setName == null || setName == "") return;
	
	setName = setName.replace('_', ' ');
	setName = setName.replace(/ \(set\)$/, '');
	
	var articleName = EsoDataFixSetNameArticle(setName);
	
		// TODO: Replace with proper check?
	var isMobile = ("ontouchstart" in document.documentElement);
	
	var safeName = setName.replace(/"/g, "&quot;");
	var safeArticle = articleName.replace(/"/g, "&quot;");
	
		// <a href=\"$link\" version=\"$version\" ismobile=\"$isMobile\" class=\"uespEsoSetLink\" setname=\"$safeName\">$title</a>
	$link.addClass("uespEsoSetLink");
	$link.attr("version", "");
	$link.attr("ismobile", isMobile ? "1" : "0");
	$link.attr("setname", safeName);
}

//TODO: Do the same for skills
//https://eso-hub.com/en/skills/sorcerer/storm-calling/mages-fury
function EsoDataUpdateAllUespSetLinks()
{
	var links = jQuery("a");
	
	links.each(function() {
		
			// https://en.uesp.net/wiki/Online:Adept_Rider?set
		if (this.href.match(/https:\/\/en.uesp.net\/wiki\/Online:.*\?set/))
		{
			EsoDataUpdateUespSetLink(this);
		}
	});
}


function EsoDataUpdateBuildSetTable($table)
{
	var body = $table.children("tbody");
	var rows = body.children("tr");
	
		// TODO: Replace with proper check?
	var isMobile = ("ontouchstart" in document.documentElement);
	
	rows.each(function() {
		var row = jQuery(this);
		var setCol = row.children("td").eq(2);
		var setName = setCol.text();
		
		var newName = EsoDataFixSetName(setName);
		var articleName = EsoDataFixSetNameArticle(setName);
		var safeName = newName.replace(/"/g, "&quot;");
		var safeArticle = articleName.replace(/"/g, "&quot;");
		var linkUrl = "https://en.uesp.net/wiki/Online:" + safeArticle;
		
		var newLink = jQuery("<a>");
		
		newLink.addClass("uespEsoSetLink");
		newLink.attr("version", "");
		newLink.attr("ismobile", isMobile ? "1" : "0");
		newLink.attr("setname", safeName);
		newLink.attr("href", linkUrl);
		newLink.attr("target", "_blank");
		newLink.html(setCol.html());
		
		setCol.html(newLink);
	});
}


function EsoDataUpdateAllBuildTableSets()
{
	if (!EsoOverrideEsoHubSets) return;
	
	var tables = jQuery("table");
	
	tables.each(function() {
		var $this = jQuery(this);
		var head = $this.children("thead");
		var body = $this.children("tbody");
		
		var col3 = head.find("td").eq(2);
		
		if (col3.text() == "Set") EsoDataUpdateBuildSetTable($this);
	});
}


function EsoDataUpdateAllEsoHubCPLinks()
{
	if (!EsoOverrideEsoHubCPs) return;
	
	var links = jQuery("a");
	
	links.each(function() {
		
			//<a href="https://eso-hub.com/en/champion-points/star/precision">Precision</a>
		if (this.href.startsWith('https://eso-hub.com/en/champion-points/') || this.href.startsWith('https://www.eso-hub.com/en/champion-points/'))
		{
			EsoDataUpdateEsoHubCPLink(this);
		}
	});
}


function EsoDataUpdateEsoHubCPLink(link)
{
	var $link = jQuery(link);
	var cpName = $link.text();
	var oldLink = $link.attr("href");
	
	var articleName = cpName;
	
		// TODO: Replace with proper check?
	var isMobile = ("ontouchstart" in document.documentElement);
	
	var safeName = cpName.replace(/"/g, "&quot;");
	var safeArticle = articleName.replace(/"/g, "&quot;");
	var newLink = "https://en.uesp.net/wiki/Online:" + safeArticle;
	
	$link.addClass("uespEsoCPLink");
	$link.attr("version", "");
	$link.attr("ismobile", isMobile ? "1" : "0");
	$link.attr("cpname", safeName);
	$link.attr("href", newLink);
	$link.attr("oldlink", oldLink);
	$link.attr("target", "_blank");
	
	var $newLink = $link.clone(false);
	
	$link.replaceWith($newLink);
}


function EsoDataSkillClientOnReady()
{
	
	/*if (g_EsoSkillIsMobile)
	{
		jQuery(".eso_skill_tooltip").click(function(e) {
			setTimeout(function() {	OnEsoSkillClientHover.bind(this, e); }, 250); 
			e.preventDefault(); 
			e.stopPropagation(); 
			return false; });
	} */
	
	EsoDataUpdateAllUespSetLinks();
	EsoDataUpdateAllEsoHubCPLinks();
	EsoDataUpdateAllEsoHubSetLinks();
	EsoDataUpdateAllBuildTableSets();
	
	jQuery(".eso_skill_tooltip").hover(OnEsoDataSkillClientHover, OnEsoDataSkillClientLeave);
	jQuery(".uespEsoCPLink").hover(OnEsoDataCPClientHover, OnEsoDataCPClientLeave);
	jQuery(".uespEsoSkillIconDiv").hover(OnEsoDataSkillClientHover, OnEsoDataSkillClientLeave);
	
	jQuery(".uespEsoSetLink").hover(OnEsoDataSetClientHover, OnEsoDataSetClientLeave);
}


jQuery( EsoDataSkillClientOnReady );
